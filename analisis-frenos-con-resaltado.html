<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>An치lisis de Frenos - Sistema Judicial</title>
    <link rel="stylesheet" href="https://cdn.tailwindcss.com/3.3.3/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        body { 
            @apply bg-gray-900 text-gray-100 m-0; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .container { 
            @apply w-full h-screen flex flex-col overflow-hidden; 
        }
        .tabs { 
            @apply flex bg-gray-800 border-b border-gray-700 fixed top-0 w-full z-10; 
        }
        .tab-button { 
            @apply flex-1 text-center py-3 text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors; 
        }
        .tab-button.active { 
            @apply bg-gray-700 text-white border-b-2 border-blue-500; 
        }
        .tab-content { 
            @apply hidden flex-1 pt-16 overflow-hidden; 
        }
        .tab-content.active { 
            @apply flex flex-col; 
        }
        .section { 
            @apply bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 flex-1 flex flex-col; 
        }
        canvas { 
            @apply w-full h-auto max-h-[180px]; 
        }
        .chart-container { 
            @apply w-full h-[280px] max-h-[280px]; 
        }
        .bubble { 
            transition: transform 0.1s ease-out; 
        }
        .button { 
            @apply text-white px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500; 
        }
        .f1-traffic-light { 
            @apply w-full max-w-[500px] h-24 flex justify-center items-center space-x-8 p-4 bg-gray-900 rounded-lg border border-gray-600 shadow-md; 
        }
        .light-pair { 
            @apply w-16 h-20 flex flex-col justify-around items-center; 
        }
        .light { 
            @apply w-10 h-10 rounded-full border-2 border-gray-500 transition-all duration-300 ease-in-out; 
        }
        .light.off { @apply bg-gray-600; }
        .light.on { @apply bg-yellow-500; }
        input, button { 
            @apply focus:outline-none focus:ring-2 focus:ring-blue-500; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pesta침as -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('nivel')">Nivel</button>
            <button class="tab-button" onclick="showTab('coeficiente')">Coeficiente de Rozamiento</button>
            <button class="tab-button" onclick="showTab('reaccion')">Tiempo de Reacci칩n</button>
        </div>

        <!-- Nivelaci칩n -->
        <section id="nivel" class="tab-content active">
            <div class="section">
                <h2 class="text-xl font-semibold mb-4 text-white">Nivelaci칩n</h2>
                <canvas id="levelCanvas" class="border border-gray-600"></canvas>
                <p class="text-center mt-3 text-sm text-gray-400">Alinea el dispositivo hasta que la burbuja est칠 centrada en la cruceta</p>
            </div>
        </section>

        <!-- An치lisis del Coeficiente de Rozamiento -->
        <section id="coeficiente" class="tab-content">
            <div class="section">
                <h2 class="text-xl font-semibold mb-4 text-white">An치lisis del Coeficiente de Rozamiento (풮)</h2>
                <div class="mb-6">
                    <label class="block text-sm text-gray-400">N칰mero de diligencias:</label>
                    <input type="text" id="diligenciasMu" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600">
                    <label class="block text-sm mt-3 text-gray-400">Matr칤cula:</label>
                    <input type="text" id="matriculaMu" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600">
                </div>
                <div class="flex space-x-3 mb-6">
                    <button id="startRecording" class="button">Iniciar Grabaci칩n</button>
                    <button id="stopRecording" class="button bg-red-600 hover:bg-red-700" disabled>Detener Grabaci칩n</button>
                </div>
                <div class="mb-6">
                    <label class="text-sm text-gray-400"><input type="checkbox" id="showSpeed" checked> Mostrar velocidad</label>
                </div>
                <p id="recordingStatus" class="text-sm text-gray-400">Estado: No grabando</p>
                <p id="gpsStatus" class="text-sm text-gray-400">Estado GPS: 游늸 Esperando se침al</p>
                <p id="gpsCoords" class="text-sm text-gray-400">Coordenadas: N/A</p>
                <p id="gpsSpeed" class="text-sm text-gray-400">Velocidad GPS: 0.0 km/h</p>
                <p id="gpsAccuracy" class="text-sm text-gray-400">Precisi칩n GPS: N/A</p>
                <p id="gpsPoints" class="text-sm text-gray-400">Puntos GPS: 0</p>
                <div class="chart-container">
                    <canvas id="accelChart"></canvas>
                </div>
                <table class="w-full text-sm mt-4 text-gray-400">
                    <tr><th>Eje X</th><td id="accelX">0</td></tr>
                    <tr><th>Eje Y</th><td id="accelY">0</td></tr>
                    <tr><th>Eje Z</th><td id="accelZ">0</td></tr>
                    <tr><th>Velocidad</th><td id="speed">0</td></tr>
                </table>
                <p class="text-sm mt-2 text-gray-400">풮 Autom치tico: <span id="muAuto">0.000</span></p>
                <p class="text-sm text-gray-400">풮 Manual: <span id="muManual">0.000</span></p>
                <p class="text-sm text-gray-400">Selecci칩n: Haga clic y arrastre en la gr치fica para seleccionar el tramo</p>
                <div class="flex space-x-3 mt-6">
                    <button id="exportAccelCSV" class="button bg-green-600 hover:bg-green-700">Exportar Datos Aceler칩metro (CSV)</button>
                    <button id="exportGPSCSV" class="button bg-green-600 hover:bg-green-700">Exportar Datos GPS (CSV)</button>
                    <button id="exportPDF" class="button bg-purple-600 hover:bg-purple-700">Generar Informe PDF</button>
                    <button id="exportExcel" class="button bg-teal-600 hover:bg-teal-700">Generar Informe Excel</button>
                </div>
                <p class="text-sm mt-2 text-gray-400">Datos certificados por An치lisis de Frenos | Hash: <span id="dataHash">N/A</span></p>
                <div class="mt-6">
                    <label class="text-gray-400"><input type="radio" name="muMode" value="auto" checked> C치lculo Autom치tico de 풮</label>
                    <label class="text-gray-400"><input type="radio" name="muMode" value="manual"> Selecci칩n Manual de Tramo</label>
                </div>
            </div>
        </section>

        <!-- Ensayo de Tiempo de Reacci칩n -->
        <section id="reaccion" class="tab-content">
            <div class="section">
                <h2 class="text-xl font-semibold mb-4 text-white">Ensayo de Tiempo de Reacci칩n</h2>
                <div class="mb-6">
                    <label class="block text-sm text-gray-400">N칰mero de diligencias:</label>
                    <input type="text" id="diligenciasReaction" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600">
                    <label class="block text-sm mt-3 text-gray-400">Matr칤cula:</label>
                    <input type="text" id="matriculaReaction" class="w-full p-2 border rounded bg-gray-700 text-gray-100 border-gray-600">
                </div>
                <div class="flex justify-center gap-6 mb-6">
                    <div class="f1-traffic-light">
                        <div class="light-pair"><div id="light1a" class="light off"></div><div id="light1b" class="light off"></div></div>
                        <div class="light-pair"><div id="light2a" class="light off"></div><div id="light2b" class="light off"></div></div>
                        <div class="light-pair"><div id="light3a" class="light off"></div><div id="light3b" class="light off"></div></div>
                        <div class="light-pair"><div id="light4a" class="light off"></div><div id="light4b" class="light off"></div></div>
                        <div class="light-pair"><div id="light5a" class="light off"></div><div id="light5b" class="light off"></div></div>
                    </div>
                </div>
                <button id="startReactionTest" class="button">Iniciar Ensayo</button>
                <button id="exportReactionPDF" class="button bg-purple-600 hover:bg-purple-700 mt-3">Exportar Informe PDF</button>
                <button id="exportReactionExcel" class="button bg-teal-600 hover:bg-teal-700 mt-3">Exportar Informe Excel</button>
                <p id="reactionResult" class="text-sm mt-2 text-gray-400 hidden">Tiempo de reacci칩n: N/A segundos</p>
                <p class="text-sm mt-2 text-gray-400">Prep치rate para tocar la pantalla cuando las luces se apaguen</p>
                <p class="text-sm mt-2 text-gray-400">Datos certificados por An치lisis de Frenos | Hash: <span id="reactionHash">N/A</span></p>
            </div>
        </section>
    </div>

    <script>
        // Gesti칩n de pesta침as (navegaci칩n instant치nea)
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // Leveling System
        const levelCanvas = document.getElementById('levelCanvas');
        const levelCtx = levelCanvas.getContext('2d');
        let bubbleX = levelCanvas.width / 2;
        let bubbleY = levelCanvas.height / 2;

        function drawLevel() {
            levelCanvas.width = levelCanvas.clientWidth;
            levelCanvas.height = 180;
            levelCtx.clearRect(0, 0, levelCanvas.width, levelCanvas.height);

            levelCtx.beginPath();
            levelCtx.rect(20, 20, levelCanvas.width - 40, levelCanvas.height - 40);
            levelCtx.strokeStyle = '#4B5563';
            levelCtx.stroke();

            levelCtx.beginPath();
            levelCtx.arc(levelCanvas.width / 2, levelCanvas.height / 2, 15, 0, Math.PI * 2);
            levelCtx.strokeStyle = '#4B5563';
            levelCtx.stroke();
            levelCtx.beginPath();
            levelCtx.moveTo(levelCanvas.width / 2, levelCanvas.height / 2 - 20);
            levelCtx.lineTo(levelCanvas.width / 2, levelCanvas.height / 2 + 20);
            levelCtx.moveTo(levelCanvas.width / 2 - 20, levelCanvas.height / 2);
            levelCtx.lineTo(levelCanvas.width / 2 + 20, levelCanvas.height / 2);
            levelCtx.stroke();

            levelCtx.beginPath();
            levelCtx.arc(bubbleX, bubbleY, 10, 0, Math.PI * 2);
            levelCtx.fillStyle = 'rgba(34, 197, 94, 0.5)';
            levelCtx.fill();
            requestAnimationFrame(drawLevel);
        }

        window.addEventListener('deviceorientation', (e) => {
            const gamma = e.gamma || 0;
            const beta = e.beta || 0;
            bubbleX = (levelCanvas.width / 2) + (gamma / 90) * (levelCanvas.width / 2 - 30);
            bubbleY = (levelCanvas.height / 2) + (beta / 90) * (levelCanvas.height / 2 - 30);
            bubbleX = Math.max(30, Math.min(levelCanvas.width - 30, bubbleX));
            bubbleY = Math.max(30, Math.min(levelCanvas.height - 30, bubbleY));
        });

        drawLevel();

        // Accelerometer Chart with Navigation and Manual Selection
        const accelChartCtx = document.getElementById('accelChart').getContext('2d');
        let accelData = { x: [], y: [], z: [], time: [], speed: [] };
        let selectionStart = null;
        let selectionEnd = null;

        const accelChart = new Chart(accelChartCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Eje X', data: [], borderColor: '#EF4444', borderWidth: 1, fill: false, pointRadius: 0 },
                    { label: 'Eje Y', data: [], borderColor: '#22C55E', borderWidth: 1, fill: false, pointRadius: 0 },
                    { label: 'Eje Z', data: [], borderColor: '#3B82F6', borderWidth: 1, fill: false, pointRadius: 0 },
                    { label: 'Velocidad', data: [], borderColor: '#F59E0B', borderWidth: 1, fill: false, pointRadius: 0, hidden: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', min: 0, max: 2.5, title: { display: true, text: 'Tiempo (s)', color: '#D1D5DB' } },
                    y: { title: { display: true, text: 'Aceleraci칩n (m/s) / Velocidad (km/h)', color: '#D1D5DB' } }
                },
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: '#D1D5DB' } },
                    zoom: {
                        pan: { enabled: true, mode: 'x', modifierKey: null },
                        zoom: {
                            pinch: { enabled: true },
                            wheel: { enabled: true },
                            mode: 'x',
                            onZoom: ({ chart }) => {
                                const { min, max } = chart.scales.x;
                                chart.options.scales.x.min = min;
                                chart.options.scales.x.max = max;
                                chart.update();
                            }
                        }
                    }
                },
                onClick: (e) => {
                    const points = accelChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                    if (points.length && document.querySelector('input[name="muMode"]:checked').value === 'manual') {
                        const index = points[0].index;
                        if (!selectionStart) selectionStart = index;
                        else if (!selectionEnd) selectionEnd = index;
                        else {
                            selectionStart = index;
                            selectionEnd = null;
                        }
                        updateSelection();
                    }
                }
            }
        });

        document.getElementById('showSpeed').addEventListener('change', (e) => {
            accelChart.data.datasets[3].hidden = !e.target.checked;
            accelChart.update();
        });

        let isRecording = false;
        let startTime = 0;
        document.getElementById('startRecording').addEventListener('click', () => {
            if (!isRecording) {
                isRecording = true;
                startTime = performance.now();
                accelData = { x: [], y: [], z: [], time: [], speed: [] };
                document.getElementById('recordingStatus').textContent = 'Estado: Grabando';
                document.getElementById('startRecording').disabled = true;
                document.getElementById('stopRecording').disabled = false;
                recordAccelData();
            }
        });

        document.getElementById('stopRecording').addEventListener('click', () => {
            if (isRecording) {
                isRecording = false;
                document.getElementById('recordingStatus').textContent = 'Estado: No grabando';
                document.getElementById('startRecording').disabled = false;
                document.getElementById('stopRecording').disabled = true;
                calculateMu();
            }
        });

        function recordAccelData() {
            if (!isRecording) return;
            window.addEventListener('devicemotion', (e) => {
                if (!isRecording) return;
                const time = (performance.now() - startTime) / 1000;
                const accel = e.accelerationIncludingGravity || { x: 0, y: 0, z: 0 };
                accelData.x.push(accel.x || 0);
                accelData.y.push(accel.y || 0);
                accelData.z.push(accel.z || 0);
                accelData.time.push(time);
                accelData.speed.push(0);
                accelChart.data.labels = accelData.time;
                accelChart.data.datasets[0].data = accelData.x;
                accelChart.data.datasets[1].data = accelData.y;
                accelChart.data.datasets[2].data = accelData.z;
                accelChart.data.datasets[3].data = accelData.speed;
                if (time > accelChart.options.scales.x.max) {
                    accelChart.options.scales.x.min += 0.1;
                    accelChart.options.scales.x.max += 0.1;
                }
                accelChart.update();
                document.getElementById('accelX').textContent = (accel.x || 0).toFixed(3);
                document.getElementById('accelY').textContent = (accel.y || 0).toFixed(3);
                document.getElementById('accelZ').textContent = (accel.z || 0).toFixed(3);
                document.getElementById('speed').textContent = '0';
            }, { once: true });
            requestAnimationFrame(recordAccelData);
        }

        function calculateMu() {
            if (document.querySelector('input[name="muMode"]:checked').value === 'auto') {
                const maxDecel = Math.max(...accelData.z.map(Math.abs));
                document.getElementById('muAuto').textContent = maxDecel.toFixed(3);
            } else if (selectionStart !== null && selectionEnd !== null) {
                const startTime = accelData.time[selectionStart];
                const endTime = accelData.time[selectionEnd];
                const zValues = accelData.z.slice(selectionStart, selectionEnd + 1);
                const maxDecel = Math.max(...zValues.map(Math.abs));
                document.getElementById('muManual').textContent = maxDecel.toFixed(3);
                selectionStart = null;
                selectionEnd = null;
                updateSelection();
            }
        }

        function updateSelection() {
            accelChart.data.datasets.forEach(dataset => {
                dataset.pointBackgroundColor = dataset.data.map((_, i) => 
                    (i === selectionStart || i === selectionEnd) ? 'rgba(59, 130, 246, 0.5)' : undefined
                );
            });
            accelChart.update();
        }

        // GPS Data
        let gpsPoints = 0;
        navigator.geolocation.watchPosition((pos) => {
            gpsPoints++;
            document.getElementById('gpsStatus').textContent = 'Estado GPS: 游늸 Conectado';
            document.getElementById('gpsCoords').textContent = `Coordenadas: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            document.getElementById('gpsSpeed').textContent = `Velocidad GPS: ${(pos.coords.speed * 3.6 || 0).toFixed(1)} km/h`;
            document.getElementById('gpsAccuracy').textContent = `Precisi칩n GPS: ${pos.coords.accuracy.toFixed(1)} m`;
            document.getElementById('gpsPoints').textContent = `Puntos GPS: ${gpsPoints}`;
        }, () => {
            document.getElementById('gpsStatus').textContent = 'Estado GPS: 游늸 Error';
        }, { enableHighAccuracy: true });

        // Export Functions
        function exportToCSV(data, filename) {
            try {
                const csv = data.map(row => Object.values(row).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                console.log(`CSV ${filename} generado correctamente`);
            } catch (error) {
                console.error('Error al exportar CSV:', error);
                alert('Error al generar el CSV. Revisa la consola.');
            }
        }

        document.getElementById('exportAccelCSV').addEventListener('click', () => {
            const data = accelData.time.map((t, i) => ({
                Time: t.toFixed(3),
                X: accelData.x[i].toFixed(3),
                Y: accelData.y[i].toFixed(3),
                Z: accelData.z[i].toFixed(3),
                Speed: accelData.speed[i].toFixed(3)
            }));
            exportToCSV(data, 'accelerometer_data.csv');
        });

        document.getElementById('exportGPSCSV').addEventListener('click', () => {
            const data = [{ id: '1', lat: 'N/A', lon: 'N/A', speed: '0', accuracy: 'N/A' }];
            exportToCSV(data, 'gps_data.csv');
        });

        document.getElementById('exportPDF').addEventListener('click', () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Helvetica', 'normal');
                doc.text('Informe de An치lisis de Frenos', 20, 20);
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = 'https://aivan84.github.io/analisis-frenos/icon.png?cache=' + new Date().getTime();
                img.onload = () => {
                    try {
                        doc.addImage(img, 'PNG', 20, 30, 40, 40);
                    } catch (imgError) {
                        console.warn('No se pudo a침adir la imagen al PDF:', imgError);
                        doc.text('No se pudo cargar el logo', 20, 40);
                    }
                    doc.text(`Diligencias: ${document.getElementById('diligenciasMu').value || 'N/A'}`, 20, 80);
                    doc.text(`Matr칤cula: ${document.getElementById('matriculaMu').value || 'N/A'}`, 20, 90);
                    doc.text(`풮 Autom치tico: ${document.getElementById('muAuto').textContent}`, 20, 100);
                    doc.text(`풮 Manual: ${document.getElementById('muManual').textContent}`, 20, 110);
                    doc.save('informe_frenos.pdf');
                    document.getElementById('dataHash').textContent = 'hash-placeholder';
                    console.log('PDF generado correctamente');
                };
                img.onerror = () => {
                    console.warn('No se pudo cargar la imagen para el PDF');
                    doc.text('No se pudo cargar el logo', 20, 40);
                    doc.text(`Diligencias: ${document.getElementById('diligenciasMu').value || 'N/A'}`, 20, 80);
                    doc.text(`Matr칤cula: ${document.getElementById('matriculaMu').value || 'N/A'}`, 20, 90);
                    doc.text(`풮 Autom치tico: ${document.getElementById('muAuto').textContent}`, 20, 100);
                    doc.text(`풮 Manual: ${document.getElementById('muManual').textContent}`, 20, 110);
                    doc.save('informe_frenos.pdf');
                    document.getElementById('dataHash').textContent = 'hash-placeholder';
                    console.log('PDF generado sin imagen');
                };
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Revisa la consola.');
            }
        });

        document.getElementById('exportExcel').addEventListener('click', () => {
            try {
                const data = [
                    ['Diligencias', document.getElementById('diligenciasMu').value || 'N/A'],
                    ['Matr칤cula', document.getElementById('matriculaMu').value || 'N/A'],
                    ['풮 Autom치tico', document.getElementById('muAuto').textContent],
                    ['풮 Manual', document.getElementById('muManual').textContent],
                    [],
                    ['Tiempo (s)', 'Eje X', 'Eje Y', 'Eje Z', 'Velocidad'],
                    ...accelData.time.map((t, i) => [
                        t.toFixed(3),
                        accelData.x[i].toFixed(3),
                        accelData.y[i].toFixed(3),
                        accelData.z[i].toFixed(3),
                        accelData.speed[i].toFixed(3)
                    ])
                ];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Informe');
                XLSX.writeFile(wb, 'informe_frenos.xlsx');
                document.getElementById('dataHash').textContent = 'hash-placeholder';
                console.log('Excel generado correctamente');
            } catch (error) {
                console.error('Error al generar Excel:', error);
                alert('Error al generar el Excel. Revisa la consola.');
            }
        });

        // Reaction Time Test with F1 Traffic Lights
        const lights = [
            [document.getElementById('light1a'), document.getElementById('light1b')],
            [document.getElementById('light2a'), document.getElementById('light2b')],
            [document.getElementById('light3a'), document.getElementById('light3b')],
            [document.getElementById('light4a'), document.getElementById('light4b')],
            [document.getElementById('light5a'), document.getElementById('light5b')]
        ];

        function resetLights() {
            lights.forEach(pair => pair.forEach(light => light.classList.remove('on').add('off')));
        }

        document.getElementById('startReactionTest').addEventListener('click', () => {
            try {
                resetLights();
                let sequence = 0;
                const interval = setInterval(() => {
                    if (sequence < 5) {
                        lights[sequence].forEach(light => light.classList.remove('off').add('on'));
                        sequence++;
                    } else {
                        clearInterval(interval);
                        setTimeout(() => {
                            resetLights();
                            const startTime = performance.now();
                            document.getElementById('reactionResult').classList.add('hidden');
                            const handler = (e) => {
                                e.preventDefault();
                                const reactionTime = (performance.now() - startTime) / 1000;
                                document.getElementById('reactionResult').textContent = `Tiempo de reacci칩n: ${reactionTime.toFixed(3)} segundos`;
                                document.getElementById('reactionResult').classList.remove('hidden');
                                document.removeEventListener('touchstart', handler);
                                document.removeEventListener('mousedown', handler);
                            };
                            document.addEventListener('touchstart', handler, { once: true });
                            document.addEventListener('mousedown', handler, { once: true });
                        }, 1000); // Apagar tras 1 segundo
                    }
                }, 1000); // 1 segundo entre cada par
                console.log('Ensayo de reacci칩n iniciado');
            } catch (error) {
                console.error('Error en el ensayo de reacci칩n:', error);
                alert('Error al iniciar el ensayo de reacci칩n. Revisa la consola.');
            }
        });

        document.getElementById('exportReactionPDF').addEventListener('click', () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(16);
                doc.text('Informe T칠cnico de Ensayo de Tiempo de Reacci칩n', 20, 20);
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = 'https://aivan84.github.io/analisis-frenos/icon.png?cache=' + new Date().getTime();
                img.onload = () => {
                    try {
                        doc.addImage(img, 'PNG', 20, 30, 40, 40);
                    } catch (imgError) {
                        console.warn('No se pudo a침adir la imagen al PDF:', imgError);
                        doc.text('No se pudo cargar el logo', 20, 40);
                    }
                    doc.setFontSize(12);
                    doc.text('Fecha: 24 de junio de 2025, 22:33 CEST', 20, 80);
                    doc.text(`Diligencias: ${document.getElementById('diligenciasReaction').value || 'N/A'}`, 20, 90);
                    doc.text(`Matr칤cula: ${document.getElementById('matriculaReaction').value || 'N/A'}`, 20, 100);
                    doc.text('Descripci칩n del Test:', 20, 110);
                    doc.text('El ensayo de tiempo de reacci칩n eval칰a la capacidad del conductor para responder a un est칤mulo visual simulado mediante un sem치foro inspirado en los est치ndares de F칩rmula 1. El sistema enciende secuencialmente cinco pares de luces dobles durante 1 segundo cada uno, seguido de un apagado tras 1 segundo adicional. El temporizador inicia al apagarse las luces y se detiene al detectar la interacci칩n del usuario (tocar la pantalla), registrando el tiempo de reacci칩n en segundos.', 20, 120, { maxWidth: 170 });
                    doc.text(`Resultado: ${document.getElementById('reactionResult').textContent || 'No realizado'}`, 20, 160);
                    doc.text('Metodolog칤a: La medici칩n se realiza utilizando la API de rendimiento del navegador, asegurando precisi칩n milisegunda. Los datos se certifican mediante un hash 칰nico generado por el sistema.', 20, 170, { maxWidth: 170 });
                    doc.save('informe_reaccion.pdf');
                    document.getElementById('reactionHash').textContent = 'hash-placeholder';
                    console.log('PDF de reacci칩n generado correctamente');
                };
                img.onerror = () => {
                    console.warn('No se pudo cargar la imagen para el PDF');
                    doc.setFontSize(12);
                    doc.text('Fecha: 24 de junio de 2025, 22:33 CEST', 20, 80);
                    doc.text(`Diligencias: ${document.getElementById('diligenciasReaction').value || 'N/A'}`, 20, 90);
                    doc.text(`Matr칤cula: ${document.getElementById('matriculaReaction').value || 'N/A'}`, 20, 100);
                    doc.text('Descripci칩n del Test:', 20, 110);
                    doc.text('El ensayo de tiempo de reacci칩n eval칰a la capacidad del conductor para responder a un est칤mulo visual simulado mediante un sem치foro inspirado en los est치ndares de F칩rmula 1. El sistema enciende secuencialmente cinco pares de luces dobles durante 1 segundo cada uno, seguido de un apagado tras 1 segundo adicional. El temporizador inicia al apagarse las luces y se detiene al detectar la interacci칩n del usuario (tocar la pantalla), registrando el tiempo de reacci칩n en segundos.', 20, 120, { maxWidth: 170 });
                    doc.text(`Resultado: ${document.getElementById('reactionResult').textContent || 'No realizado'}`, 20, 160);
                    doc.text('Metodolog칤a: La medici칩n se realiza utilizando la API de rendimiento del navegador, asegurando precisi칩n milisegunda. Los datos se certifican mediante un hash 칰nico generado por el sistema.', 20, 170, { maxWidth: 170 });
                    doc.save('informe_reaccion.pdf');
                    document.getElementById('reactionHash').textContent = 'hash-placeholder';
                    console.log('PDF de reacci칩n generado sin imagen');
                };
            } catch (error) {
                console.error('Error al generar PDF de reacci칩n:', error);
                alert('Error al generar el PDF de reacci칩n. Revisa la consola.');
            }
        });

        document.getElementById('exportReactionExcel').addEventListener('click', () => {
            try {
                const data = [
                    ['Diligencias', document.getElementById('diligenciasReaction').value || 'N/A'],
                    ['Matr칤cula', document.getElementById('matriculaReaction').value || 'N/A'],
                    ['Tiempo de Reacci칩n', document.getElementById('reactionResult').textContent.replace('Tiempo de reacci칩n: ', '') || 'N/A']
                ];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Informe Reacci칩n');
                XLSX.writeFile(wb, 'informe_reaccion.xlsx');
                document.getElementById('reactionHash').textContent = 'hash-placeholder';
                console.log('Excel de reacci칩n generado correctamente');
            } catch (error) {
                console.error('Error al generar Excel de reacci칩n:', error);
                alert('Error al generar el Excel de reacci칩n. Revisa la consola.');
            }
        });
    </script>
</body>
</html>